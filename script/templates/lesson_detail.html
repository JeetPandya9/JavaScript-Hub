{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5 pt-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'course_detail' course.id %}">{{ course.title }}</a></li>
            <li class="breadcrumb-item active">{{ lesson.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Lesson Header -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h2 class="mb-2">{{ lesson.title }}</h2>
                            <p class="text-muted mb-0">{{ lesson.module.title }} â€¢ {{ lesson.duration_minutes }} minutes</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary fs-6">Lesson {{ current_index|add:1 }} of {{ total_lessons }}</span>
                        </div>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Your Progress</span>
                            <span class="fw-bold">{{ progress.progress_percentage }}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" style="width: {{ progress.progress_percentage }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Section -->
            {% if lesson.video_url %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-video me-2"></i>
                        Video Tutorial
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="ratio ratio-16x9">
                        <iframe src="{{ lesson.video_url }}" 
                                title="{{ lesson.title }}" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen></iframe>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Lesson Content -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-book me-2"></i>
                        Lesson Content
                    </h5>
                </div>
                <div class="card-body">
                    <div class="lesson-content">
                        {{ lesson.content|linebreaks }}
                    </div>
                </div>
            </div>

            <!-- Code Examples -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-code me-2"></i>
                        Code Examples
                    </h5>
                </div>
                <div class="card-body">
                    <div class="code-example mb-3">
                        <h6>Basic Example:</h6>
                        <pre><code class="language-javascript">// Example code for this lesson
console.log("Hello, JavaScript!");
let message = "Welcome to JavaScriptHub";
alert(message);</code></pre>
                    </div>
                    
                    <div class="code-example">
                        <h6>Interactive Example:</h6>
                        <div class="bg-light p-3 rounded">
                            <button class="btn btn-primary" onclick="showExample()">Run Example</button>
                            <div id="output" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Practice Exercise -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>
                        Practice Exercise
                    </h5>
                </div>
                <div class="card-body">
                    <p>Complete the following exercise to reinforce what you've learned:</p>
                    <div class="bg-light p-3 rounded mb-3">
                        <h6>Exercise:</h6>
                        <p>Create a simple JavaScript function that takes a name as a parameter and returns a greeting message.</p>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exerciseCode" class="form-label">Your Code:</label>
                        <textarea class="form-control" id="exerciseCode" rows="6" placeholder="Write your JavaScript code here..."></textarea>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="runExercise()">
                            <i class="fas fa-play me-2"></i>Run Code
                        </button>
                        <button class="btn btn-success" onclick="markAsComplete()">
                            <i class="fas fa-check me-2"></i>Mark as Complete
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Course Progress -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Course Progress
                    </h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="progress-circle" style="width: 100px; height: 100px; margin: 0 auto;">
                            <div class="progress-circle-inner d-flex align-items-center justify-content-center">
                                <span class="fw-bold">{{ progress.progress_percentage }}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <small class="text-muted">{{ current_index|add:1 }} of {{ total_lessons }} lessons completed</small>
                    </div>
                </div>
            </div>

            <!-- Lesson Navigation -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Course Lessons
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for module in course.modules.all %}
                            <div class="list-group-item bg-light">
                                <strong>{{ module.title }}</strong>
                            </div>
                            {% for lesson_item in module.lessons.all %}
                                <a href="{% url 'lesson_detail' course.id lesson_item.id %}" 
                                   class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                                          {% if lesson_item.id == lesson.id %}active{% endif %}">
                                    <div>
                                        <i class="fas fa-play-circle me-2"></i>
                                        {{ lesson_item.title }}
                                    </div>
                                    {% if lesson_item.id == lesson.id %}
                                        <i class="fas fa-arrow-right"></i>
                                    {% endif %}
                                </a>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="card">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if prev_lesson %}
                            <a href="{% url 'lesson_detail' course.id prev_lesson.id %}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left me-2"></i>Previous Lesson
                            </a>
                        {% endif %}
                        
                        {% if next_lesson %}
                            <a href="{% url 'lesson_detail' course.id next_lesson.id %}" 
                               class="btn btn-primary">
                                Next Lesson<i class="fas fa-arrow-right ms-2"></i>
                            </a>
                        {% else %}
                            <a href="{% url 'course_detail' course.id %}" 
                               class="btn btn-success">
                                <i class="fas fa-trophy me-2"></i>Complete Course
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.progress-circle {
    position: relative;
    border-radius: 50%;
    background: conic-gradient(#007bff {{ progress.progress_percentage }}%, #e9ecef 0%);
}

.progress-circle-inner {
    position: absolute;
    top: 5px;
    left: 5px;
    right: 5px;
    bottom: 5px;
    background: white;
    border-radius: 50%;
}

.lesson-content {
    font-size: 1.1rem;
    line-height: 1.7;
}

.code-example pre {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 1rem;
    margin: 0;
}
</style>

<script>
function showExample() {
    document.getElementById('output').innerHTML = '<div class="alert alert-info">Hello, JavaScript! Welcome to JavaScriptHub</div>';
}

function runExercise() {
    const code = document.getElementById('exerciseCode').value;
    try {
        // Simple code execution (in a real app, you'd want proper sandboxing)
        const result = eval(code);
        document.getElementById('output').innerHTML = '<div class="alert alert-success">Code executed successfully!</div>';
    } catch (error) {
        document.getElementById('output').innerHTML = '<div class="alert alert-danger">Error: ' + error.message + '</div>';
    }
}

function markAsComplete() {
    // Send AJAX request to update progress
    fetch('{% url "update_lesson_progress" lesson.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: 'progress_percentage=100&is_completed=true'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Lesson marked as complete!');
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Add CSRF token to the page
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        const token = document.createElement('input');
        token.type = 'hidden';
        token.name = 'csrfmiddlewaretoken';
        token.value = '{{ csrf_token }}';
        document.body.appendChild(token);
    }
});
</script>
{% endblock %}
